# Base Docker Compose configuration for Chatterbox TTS API
# This is the default configuration that can be extended by other compose files
# 
# Usage:
#   docker compose up                           # Use this base config (auto device detection)
#   docker compose -f docker-compose.cpu.yml up # CPU-only mode
#   docker compose -f docker-compose.gpu.yml up # GPU mode with NVIDIA runtime
#
# For frontend:
#   docker compose --profile frontend up

version: '3.8'

x-common-environment: &common-environment
  # API Configuration
  PORT: ${PORT:-4123}
  HOST: ${HOST:-0.0.0.0}

  # TTS Model Settings
  TTS_MODEL_TYPE: ${TTS_MODEL_TYPE:-multilingual}
  EXAGGERATION: ${EXAGGERATION:-0.5}
  CFG_WEIGHT: ${CFG_WEIGHT:-0.5}
  TEMPERATURE: ${TEMPERATURE:-0.8}

  # Text Processing
  MAX_CHUNK_LENGTH: ${MAX_CHUNK_LENGTH:-280}
  MAX_TOTAL_LENGTH: ${MAX_TOTAL_LENGTH:-3000}

  # Long Text TTS Settings
  LONG_TEXT_DATA_DIR: /data/long_text_jobs
  LONG_TEXT_MAX_LENGTH: ${LONG_TEXT_MAX_LENGTH:-100000}
  LONG_TEXT_CHUNK_SIZE: ${LONG_TEXT_CHUNK_SIZE:-2500}
  LONG_TEXT_SILENCE_PADDING_MS: ${LONG_TEXT_SILENCE_PADDING_MS:-200}
  LONG_TEXT_JOB_RETENTION_DAYS: ${LONG_TEXT_JOB_RETENTION_DAYS:-7}
  LONG_TEXT_MAX_CONCURRENT_JOBS: ${LONG_TEXT_MAX_CONCURRENT_JOBS:-3}

  # Voice and Model Settings
  VOICE_SAMPLE_PATH: /app/voice-sample.mp3
  DEVICE: ${DEVICE:-auto}
  MODEL_CACHE_DIR: /cache
  VOICE_LIBRARY_DIR: /voices

  # Memory Settings
  MEMORY_CLEANUP_INTERVAL: ${MEMORY_CLEANUP_INTERVAL:-5}
  CUDA_CACHE_CLEAR_INTERVAL: ${CUDA_CACHE_CLEAR_INTERVAL:-3}
  ENABLE_MEMORY_MONITORING: ${ENABLE_MEMORY_MONITORING:-true}

  # Hugging Face Settings
  HF_TOKEN: ${HF_TOKEN:-}
  HF_HOME: /cache/huggingface

services:
  chatterbox-tts:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        BASE_IMAGE: python:3.11-slim
        PYTORCH_VERSION: 2.6.0
        TORCHVISION_VERSION: 0.21.0
        TORCHAUDIO_VERSION: 2.6.0
        PYTORCH_INDEX: https://download.pytorch.org/whl/cpu
        DEVICE: auto
        NEEDS_PYTHON_INSTALL: "false"
        EXTRA_PACKAGES: ""
    container_name: chatterbox-tts-api
    ports:
      - '${PORT:-4123}:${PORT:-4123}'
    environment:
      <<: *common-environment
    volumes:
      - ${VOICE_SAMPLE_HOST_PATH:-../voice-sample.mp3}:/app/voice-sample.mp3:ro
      - ../app:/app/app:ro
      - ../tests:/app/tests:ro
      - ../requirements.txt:/app/requirements.txt:ro
      - ../pyproject.toml:/app/pyproject.toml:ro
      - chatterbox-models:/cache
      - chatterbox-voices:/voices
      - chatterbox-longtext-data:/data/long_text_jobs
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${PORT:-4123}/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  frontend:
    profiles: ['frontend']
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: chatterbox-tts-frontend
    ports:
      - '${FRONTEND_PORT:-4321}:80'
    depends_on:
      - chatterbox-tts
    restart: unless-stopped

volumes:
  chatterbox-models:
    driver: local
  chatterbox-voices:
    driver: local
  chatterbox-longtext-data:
    driver: local
